<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>流量终端 - Fluent Design</title>
    <style>
        :root {
            --fluent-accent: #0078D4;
            --mica-bg: rgba(243, 243, 243, 0.85);
            --card-bg: rgba(255, 255, 255, 0.7);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI Variable Display", "Segoe UI", sans-serif; }

        body {
            background: radial-gradient(circle at 0% 0%, rgba(255, 0, 120, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 100% 100%, rgba(0, 120, 212, 0.3) 0%, transparent 50%), #f3f3f3;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex; justify-content: center; align-items: flex-start;
            padding: 40px 20px 100px 20px; overflow-y: auto;
        }

        .container { width: 100%; max-width: 400px; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* 亚克力卡片 */
        .fluent-card {
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            padding: 24px; position: relative; overflow: hidden;
        }

        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .header h1 { font-size: 20px; font-weight: 600; color: #1a1a1a; }
        
        /* 配置图标按钮 */
        .config-btn { background: none; border: none; cursor: pointer; color: #616161; font-size: 20px; padding: 5px; }

        /* 环形进度 */
        .visual-area { position: relative; width: 200px; height: 200px; margin: 0 auto 30px; }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .circle-track { fill: none; stroke: rgba(0,0,0,0.05); stroke-width: 10; }
        .circle-fill {
            fill: none; stroke: var(--fluent-accent); stroke-width: 10; stroke-linecap: round;
            stroke-dasharray: 565; stroke-dashoffset: 565;
            transition: stroke-dashoffset 2s cubic-bezier(0.1, 0.9, 0.2, 1);
        }

        .data-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .remain-val { font-size: 44px; font-weight: 700; color: #000; }
        .remain-label { font-size: 12px; color: #616161; font-weight: 600; }

        /* 数据网格 */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-box { background: rgba(255, 255, 255, 0.4); padding: 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); }
        .stat-label { font-size: 11px; color: #616161; font-weight: 600; margin-bottom: 4px; display: block; }
        .stat-num { font-size: 15px; font-weight: 700; color: #1a1a1a; }

        /* 配置面板 - 默认隐藏 */
        #configPanel {
            position: absolute; inset: 0; background: #f9f9f9; z-index: 100;
            padding: 24px; display: none; flex-direction: column;
        }
        input { 
            width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 4px; 
            font-size: 14px; background: white;
        }
        .primary-btn {
            background: var(--fluent-accent); color: white; border: none; padding: 12px;
            border-radius: 4px; font-weight: 600; cursor: pointer;
        }

        /* 加载动画 */
        #loader {
            position: absolute; inset: 0; background: var(--mica-bg);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 90;
        }
        .spinner { width: 30px; height: 30px; border: 3px solid rgba(0, 120, 212, 0.1); border-top-color: var(--fluent-accent); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .footer { margin-top: 24px; text-align: center; font-size: 11px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <div class="fluent-card">
        <div id="loader">
            <div class="spinner"></div>
            <p style="margin-top:12px; font-size:12px; color:var(--fluent-accent)">正在获取数据...</p>
        </div>

        <div id="configPanel">
            <h2 style="font-size: 18px; margin-bottom: 10px;">终端配置</h2>
            <p style="font-size: 12px; color: #666;">请输入设备号，配置将加密保存在本地浏览器中。</p>
            <input type="text" id="devInput" placeholder="请输入设备号 (例如: 8681700102)">
            <button class="primary-btn" onclick="saveConfig()">保存并连接</button>
            <button style="margin-top:10px; background:none; border:none; color:#666; font-size:12px; cursor:pointer;" onclick="toggleConfig(false)">返回</button>
        </div>

        <div class="header">
            <div>
                <h1 id="displayNote">流量概览</h1>
                <p style="font-size:11px; color:#666;" id="displayID">ID: 未配置</p>
            </div>
            <button class="config-btn" onclick="toggleConfig(true)">⚙️</button>
        </div>

        <div class="visual-area">
            <svg viewBox="0 0 200 200">
                <circle class="circle-track" cx="100" cy="100" r="90"></circle>
                <circle id="ring" class="circle-fill" cx="100" cy="100" r="90"></circle>
            </svg>
            <div class="data-overlay">
                <div id="remainVal" class="remain-val">0.00</div>
                <div class="remain-label">剩余 GB</div>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <span class="stat-label">套餐总量</span>
                <span id="totalVal" class="stat-num">-- GB</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">已使用</span>
                <span id="usedVal" class="stat-num">-- GB</span>
            </div>
            <div class="stat-box" style="grid-column: span 2;">
                <span class="stat-label">服务到期时间</span>
                <span id="expireVal" class="stat-num">----/--/--</span>
            </div>
        </div>

        <button class="primary-btn" style="width:100%; margin-top:20px;" onclick="fetchData()">刷新状态</button>
    </div>

    <div class="footer">
        <p>By Eugene | 数据仅供参考</p>
    </div>
</div>

<script>
    const API_URL = 'http://rang.xuanrangiot.cn/api/card/intelligentDetection';

    // 1. 初始化检查本地存储 
    function checkConfig() {
        const savedID = localStorage.getItem('user_dev_id'); // [cite: 76, 78]
        if (!savedID) {
            toggleConfig(true); // 如果没有配置，弹出配置面板
            document.getElementById('loader').style.display = 'none';
        } else {
            document.getElementById('displayID').innerText = 'ID: ' + savedID;
            fetchData();
        }
    }

    // 2. 保存配置 [cite: 89]
    function saveConfig() {
        const input = document.getElementById('devInput').value.trim();
        if (input) {
            localStorage.setItem('user_dev_id', input); // [cite: 78, 92]
            toggleConfig(false);
            location.reload();
        } else {
            alert('请输入有效的设备号');
        }
    }

    // 3. 切换面板显示 [cite: 158]
    function toggleConfig(show) {
        document.getElementById('configPanel').style.display = show ? 'flex' : 'none';
    }

    // 4. 获取数据 (内核修复版) [cite: 126]
    function fetchData() {
        const devId = localStorage.getItem('user_dev_id');
        if (!devId) return;

        document.getElementById('loader').style.display = 'flex';
        document.getElementById('loader').style.opacity = '1';

        const cb = `jsonp_${Date.now()}`;
        window[cb] = function(res) {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);

            if (res.code === 1 && res.data) {
                const d = res.data;
                const total = d.totalAmount / 1024 || 0;
                const remain = (d.remainAmount || d.surplus || 0) / 1024;
                const used = total - remain;
                const percent = total > 0 ? (remain / total) : 0;

                // 更新 UI [cite: 137]
                document.getElementById('totalVal').innerText = total.toFixed(2) + ' GB';
                document.getElementById('usedVal').innerText = used.toFixed(2) + ' GB';
                document.getElementById('expireVal').innerText = d.expiretime ? d.expiretime.split(' ')[0] : '长期有效';
                
                // 动画效果 [cite: 148]
                animateValue("remainVal", 0, remain, 1500);
                document.getElementById('ring').style.strokeDashoffset = 565 - (percent * 565);
            } else {
                alert(res.msg || '获取失败，请检查设备号是否正确');
            }
            document.body.removeChild(script);
            delete window[cb];
        };

        const script = document.createElement('script');
        script.src = `${API_URL}?dev_no=${devId}&callback=${cb}`;
        document.body.appendChild(script);
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = (progress * (end - start) + start).toFixed(2);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    window.onload = checkConfig; // [cite: 154]
</script>

</body>
</html>
